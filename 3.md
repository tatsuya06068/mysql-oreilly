# サーバーのパフォーマンスのプロファイリング

パフォーマンス関連の調査する対象として下記3つがある。
1. サーバーが全ての処理を最適な状態で行っているか
2. 特定のクエリの実行パフォーマンスのが十分なのか
3. 継続的に発生する不可解な出来事のトラブルシューティング

不可解な出来事とはよく「ストール」「パイルアップ」「フリーズ」と呼ばれている。

この章ではこの3のパフォーマンス調査をするための、サーバーの全体的なワークロードの高速化、個々のクエリの高速化、特定が難しい問題や、原因はおろかどのような形で現れるかもわからない問題のトラブルシューティングに役立つツールとテクニックを紹介している。

主にサーバー上で時間のかかっている処理を計測する。それを手助けする方法がプロファイリングと呼ばれている。

# 3.1 速習：パフォーマンスの最適化

本章ではパフォーマンスとは「タスクを完了するのに必要な時間として計測されるもの」として定義している。
また、パフォーマンスの最適化とは特定のワークロードの応答時間をできるだけ短くするための処置としている。

最適化するための検討すべき内容は様々ある。

1. CPUの使用率
    1. CPUの使用率を下げるためにクエリの最適化などでリソース消費の削減が必要。

2. MySQLのアップグレード
    1. MySQLのアップグレードかなり古いInnnoDBが含まれているMySQLをアップグレードすることで、CPU使用率を劇的に上昇することもある。逆にアップグレードによってインデックスを使用しないといったバグが紛れ込む可能性もあるため、クエリの応答時間を確認することが必要。

3. スループットの改善
    1. スループットはパフォーマンスの最適化の副作用と見なすことができる。
クエリを最適化すれば、サーバーが１秒あたりに実行できるクエリの数を増やすことが可能になる。また、サーバーが最適化されていれば、個々のクエリを実行するのにかかる時間が短くなる。

4. 応答時間の短縮
    1.  サーバーがクエリｈじぇの応答に一定の時間を要する理由を理解し、結果を得るためにサーバーが行っている無駄な作業を減らすか、なくしてしまう必要がある。そのため、まずはどこで時間が費やされているか計測が必要。

何かを最適化するときには、応答時間に費やされている場所を探すのに計測をする時間をかけるのが良い。

実際に最適化のターゲットにするタスクを判断するのにプロファイリングが活用できる。

# 3.1.1 プロファイリングによる最適化
プロファイリングは、長時間かかっている場所を計測し、分析するための主な手段である。

プロファイリングは２つの手順に分かれている。
- タスクと所要時間を計測する作業
- 結果を集計してタスクを重要なものから並べていく作業

プロファイリングのツールはどれも同じような仕組みでできている。
1. タスクが開始されたらタイマーを作動。
2. タスクが終了したらタイマーを停止。
3. 終了時間から開始時間を差し引いて応答時間を割り出す。

結果として得られたデータはコールグラフの生成に使用できる。
また、プロファイルレポートを見ることで、同じようなタスクをまとめて集計してそれらのタスクの数とそれらの応答時間の合計を知ることができる。
プロファイルレポートは、タスクが１行に１つずつ含まれたテーブルで構成されている。
各行に下記が登録されている。
- タスクの名前
- タスクが実行された回数
- 合計所要時間
- 実行あたりの平均時間
- タスクによる全体に対する消費割合

プロファイルレポートは、合計所要時間が長いものから順にソートするのが望ましい。

Percona Toolkit の pt-query-digest ツールで出力した結果が下記となる。
```
Rank    Response time            Calls       R/Call     Item
====  ================  =====  ======  =======
        1  11256.3618 68.1%       78069    0.1442     SELECT InvitesNew
        2  2029.4730 12.3%         14415    0.1408     SELECT StatusUpdate
        3  1345.3445 8.1%           3520      0.3822      SHOW STATUS
```

各行には、応答時間の合計と全体に占める割合、クエリが実行された回数、クエリあたりの平均応答時間、クエリの概要が表示されています。
このプロファイルは、各種のクエリの負荷と相対的な負荷、全体を基準にした場合の負荷を明らかにしています。
この場合のタスクはクエリであり、MySQLをプロファイルするときの最も一般的な方法である。

### 実行時プロファイルングと待機分析の2種類のプロファイリングについて
- 実行時プロファイリングは、最も時間のかかるタスクを示す。
    - リソースを過剰に消費し、ほとんどの時間を実行に費やしているときに使用できる。 
- 待機分析は、タスクがブロックされている時間が最も長い場所を示す。
    - タスクが常に待機していて、リソースを全くしない場合に使用できる。

どちらの時間消費が問題医であるかわからに場合は、両方の分析を実行してみるのが良い。

プロファイリングで所要時間の大半があるタスクに関係していることが和kった場合、詳しく調べて見ると「実行時間」の一部が低レベルでの待機に費やされていることが判明するかもしれないです。
例えば例に上げたプロファイルでは、`SELECT InvitesNew`に時間がかかっていることがわかったが、詳しく調べるとI/Oの完了を待機していたことがわかるかもしれないです。

システムのプロファイリングを実行するには、システムのパフォーマンスを計測できなければならないため、***インストルメンテーション***（計測機能）が必要となります。
インストルメンテーション対応のシステムには、データを補足するための計測点とデータを収集できるようにするための何らかの方法が備わっている必要がある。
MySQLはバージョン5.5から導入された`Performance Schima`の最初のバージョンで、提供されるようになった。

インストルメンテーションが十分な環境ではなくても、多くの場合はシステムを外部から計測することが可能です。

# 3.1.2 プロファイルを解釈する
先程のプロファイルではランク、合計、平均しか示されていないため、不明点が４点ある。

***最適化に値するクエリ***

プロファイリングでは、最適化に時間をかける価値のあるクエリは自動的に示されない。
そのため、最適化をするものを考える必要がある。
最適化を考えるポイントポイントが2点ある。
- 応答時間を占める割合が小さいタスクは最適化する価値がない
- タスクの最適化にかかるコストが1000ドルとして、結果としてビジネス収益につながらない場合


***外れ道***

プロファイルの先頭にソートされないタスクでも最適化が必要かもしれない。
全体の応答時間の中で大きな割合を占めるほど頻繁に発生しないとしても、頻繁に利用する場所などは最適化が必要。

***未知の不確定要素***

損失時間が今回のプロファイルではわからず、ツールによっては損失時間を示すことが可能。
たとえば、CPU時間の計測値が10秒であるのに対し、サブタスクのプロファイル値を合計すると9.7秒になる場合、300ミリ秒の損失時間がある。原因は丸め誤差や計測自体のコストによってやむを得ずそうなったのかもしれない。もしかすると何か重要なものを見逃しているかもしれないため常に損失時間があることを意識したほうが良い。

***埋もれている詳細***

プロファイルは応答時間の内訳をいっさい示さない。平均の応答時間では、どういった場合では応答時間が遅いのかやどういった場合では応答時間が早いといったことがわからない。そのため、ヒストグラム、パーセンタイル、標準偏差、分散指数など、応答時間に関する情報がもっとあればさらに効果的である。

pt-query-digest といったツールでは、こうした詳細の多くをプロファイルにまとめ、そのプロファイルから詳細なレポートを生成してくれる。

# 3.2 アプリケーションのプロファイリング

アプリケーションもプロファイリングができる。
基本的にはデータベースよりもアプリケーションのほうが簡単にプロファイリングができる。

計測とプロファイリングはトップダウン方式で行うほうがよい。そうすればユーザーからサーバーへ、再びユーザーへとシステムの流れるタスクを追跡できるようになる。パフォーマンスの問題はデータベースであることが多いが、アプリケーションが原因であることもある。
ボトルネックの原因として、他に以下のようなものが考えられる。
- Webサービスや検索エンジンの呼び出しといった外部リソース
- 大きなXMLファイルの解析など、対象のデータの処理を要求する操作
- 正規表現をいたずらに使用するなど、タイトループでのコストのかかる操作
- リストからアイテムを見つけ出す安直な検索アルゴリズムなど、最適化が不十分なアルゴリズム

これらのパフォーマンスがよければ、アプリケーションが問題か、MySQLが問題かすぐにわかることができる。
プロファインリグのツールとして、本書では`New Relic`というSaas製品が良いと記載されている。
New Relic をアプリケーションに接続し、アプリケーションをプロファイルし、データを Web ベースのダッシュボードに送信すれば、応答時間に基づいてアプリケーションのパフォーマンスを簡単に検証できるようになる。
開発環境だけでなく稼働環境でもコードを診断することができ、常に診断することができる。

# 3.2.1 PHPアプリケーションのプロファイリング
PHPのプロファイリングツールには`New Relic`以外に下記がある。
- XHProf
- Xdebug
- Valgrind
- Cachegrid
- IfP

ツールによっては、冗長でオーバーヘッドがたかkために実際の稼働環境には向かないものもある。

## IfPを使用したプロファイリング
IfPはデータベースにうまくアクセスできない、あるいはデータベースをうまく制御できない場合に、アプリケーションによるデータベースの使用をプロファイルするためのかけがえのないツールとなる。

ページの実行を開始する箇所に下記を最初に呼び出しておけば、IfPでのプロファイリグができる。
```
require_once('Instrumentation.php');
Instrumentation::get_instance()->start_request();
```

IfpはSQLのクエリにコメントを自動的に追加するため、DBのクエリログを調べることでアプリケーションを柔軟に分析ができる。
また、`SHOW PROCESSLIST`を調べれば実際にどういうクエリが来ているのか確認ができ、不正なクエリも確認できる。






# 3.3 MySQLクエリのプロファイリング
# 3.4 継続的な問題の診断
# 3.5 その他のプロファイリングツール
# 3.6 まとめ